<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu Management - Hotel Lee Admin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f8f9fa;
        color: #2c3e50;
      }
      .admin-header {
        background: #2c3e50;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
      }
      .admin-nav {
        background: #34495e;
      }
      .nav-links {
        display: flex;
        list-style: none;
      }
      .nav-links li {
        border-right: 1px solid #2c3e50;
      }
      .nav-links li:last-child {
        border-right: none;
      }
      .nav-links a {
        display: block;
        color: white;
        padding: 1rem 1.5rem;
        text-decoration: none;
        transition: background 0.2s;
      }
      .nav-links a:hover,
      .nav-links a.active {
        background: #2c3e50;
      }
      .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
      }
      @media (max-width: 768px) {
        .nav-links {
          flex-direction: column;
        }
        .nav-links li {
          border-right: none;
          border-bottom: 1px solid #2c3e50;
        }
      }
      main {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .action-btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        color: white;
      }
      .add-item-btn {
        background: #27ae60;
      }
      .add-category-btn {
        background: #3498db;
      }
      .action-btn:hover {
        opacity: 0.9;
      }

      .management-section {
        background: white;
        margin-bottom: 2rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .section-header {
        background: #ecf0f1;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #bdc3c7;
      }
      .section-header h3 {
        margin: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
      }
      .table-btn {
        padding: 0.3rem 0.8rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: white;
        margin-right: 0.5rem;
      }
      .edit-btn {
        background: #3498db;
      }
      .delete-btn {
        background: #e74c3c;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal h3 {
        margin-top: 0;
        color: #2c3e50;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #2c3e50;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }
      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
      }
      .form-actions button {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-cancel {
        background: #95a5a6;
        color: white;
      }
      .btn-save {
        background: #27ae60;
        color: white;
      }

      .category-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .category-tag {
        background: #3498db;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .checkbox-item input[type="checkbox"] {
        width: auto;
      }
    </style>
  </head>
  <body>
    <header class="admin-header">
      <h1>üè® Hotel Lee Admin Dashboard</h1>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </header>
    <nav class="admin-nav">
      <ul class="nav-links">
        <li><a href="dashboard.html">üìä Dashboard</a></li>
        <li><a href="orders-management.html">üì¶ Orders</a></li>
        <li><a href="users.html">üë• Users</a></li>
        <li><a href="menu-management.html" class="active">üçï Menu</a></li>
      </ul>
    </nav>
    <main>
      <h2>üçï Menu & Category Management</h2>

      <div class="action-buttons">
        <button class="action-btn add-item-btn" id="add-item-btn">
          + Add New Item
        </button>
        <button class="action-btn add-category-btn" id="add-category-btn">
          + Add New Category
        </button>
      </div>

      <!-- Categories Section -->
      <div class="management-section">
        <div class="section-header">
          <h3>üìÇ Categories</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Description</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="categories-body">
            <tr>
              <td colspan="4" style="text-align: center">
                Loading categories...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Menu Items Section -->
      <div class="management-section">
        <div class="section-header">
          <h3>üçΩÔ∏è Menu Items</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Price</th>
              <th>Categories</th>
              <th>Available</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="menu-body">
            <tr>
              <td colspan="6" style="text-align: center">
                Loading menu items...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
      <div class="modal-content">
        <h3 id="category-modal-title">Add New Category</h3>
        <form id="category-form">
          <div class="form-group">
            <label>Category ID</label>
            <input
              type="text"
              id="category-id"
              required
              placeholder="e.g., chinese-food"
            />
          </div>
          <div class="form-group">
            <label>Category Name</label>
            <input
              type="text"
              id="category-name"
              required
              placeholder="e.g., Chinese Food"
            />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea
              id="category-description"
              placeholder="Brief description of the category"
            ></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="cancel-category">
              Cancel
            </button>
            <button type="submit" class="btn-save" id="save-category">
              Save Category
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Item Modal -->
    <div id="item-modal" class="modal">
      <div class="modal-content">
        <h3 id="item-modal-title">Add New Item</h3>
        <form id="item-form">
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="item-name" required />
          </div>
          <div class="form-group">
            <label>Price (‚Çπ)</label>
            <input type="number" id="item-price" required />
          </div>
          <div class="form-group">
            <label>Categories (Select multiple)</label>
            <div class="checkbox-group" id="category-checkboxes">
              <!-- Category checkboxes will be loaded here -->
            </div>
          </div>
          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="item-image" required />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="item-description"></textarea>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="item-available" checked /> Available
              for order
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" id="cancel-item">
              Cancel
            </button>
            <button type="submit" class="btn-save" id="save-item">
              Save Item
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        deleteDoc,
        setDoc,
        updateDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBMACWaT2ESi5A-q2vzBeNdWJZQDvDYOfk",
        authDomain: "hotel-lee.firebaseapp.com",
        projectId: "hotel-lee",
        storageBucket: "hotel-lee.firebasestorage.app",
        messagingSenderId: "763270960235",
        appId: "1:763270960235:web:5343e8f87976424642cd2e",
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let allCategories = [];
      let editingItemId = null;
      let editingCategoryId = null;

      onAuthStateChanged(auth, (user) => {
        if (!user || user.email !== "admin@lee.com") {
          window.location.href = "login.html";
          return;
        }
        console.log("‚úÖ Admin authenticated:", user.email);
        loadData();
      });

      async function loadData() {
        await loadCategories();
        await loadMenuItems();
      }

      async function loadCategories() {
        try {
          const snapshot = await getDocs(collection(db, "categories"));
          const tbody = document.getElementById("categories-body");
          tbody.innerHTML = "";

          allCategories = [];
          snapshot.forEach((doc) => {
            const category = { id: doc.id, ...doc.data() };
            allCategories.push(category);

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${doc.id}</td>
            <td>${category.name}</td>
            <td>${category.description || "No description"}</td>
            <td>
              <button class="table-btn edit-btn" onclick="editCategory('${
                doc.id
              }')">Edit</button>
              <button class="table-btn delete-btn" onclick="deleteCategory('${
                doc.id
              }')">Delete</button>
            </td>
          `;
            tbody.appendChild(tr);
          });

          updateCategoryCheckboxes();
          console.log("‚úÖ Loaded", allCategories.length, "categories");
        } catch (error) {
          console.error("‚ùå Error loading categories:", error);
        }
      }

      async function loadMenuItems() {
        try {
          const snapshot = await getDocs(collection(db, "menuItems"));
          const tbody = document.getElementById("menu-body");
          tbody.innerHTML = "";

          snapshot.forEach((doc) => {
            const item = doc.data();

            // Format categories for display
            let categoriesDisplay = "None";
            if (item.categories && Array.isArray(item.categories)) {
              categoriesDisplay = item.categories
                .map((catId) => {
                  const cat = allCategories.find((c) => c.id === catId);
                  return cat ? cat.name : catId;
                })
                .join(", ");
            } else if (item.categoryId) {
              const cat = allCategories.find((c) => c.id === item.categoryId);
              categoriesDisplay = cat ? cat.name : item.categoryId;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${doc.id}</td>
            <td>${item.name}</td>
            <td>‚Çπ${item.price}</td>
            <td>
              <div class="category-tags">
                ${categoriesDisplay}
              </div>
            </td>
            <td>${item.isAvailable ? "‚úÖ Yes" : "‚ùå No"}</td>
            <td>
              <button class="table-btn edit-btn" onclick="editItem('${
                doc.id
              }')">Edit</button>
              <button class="table-btn delete-btn" onclick="deleteItem('${
                doc.id
              }')">Delete</button>
            </td>
          `;
            tbody.appendChild(tr);
          });

          console.log("‚úÖ Loaded menu items");
        } catch (error) {
          console.error("‚ùå Error loading menu items:", error);
        }
      }

      function updateCategoryCheckboxes() {
        const container = document.getElementById("category-checkboxes");
        container.innerHTML = "";

        allCategories.forEach((category) => {
          const checkboxDiv = document.createElement("div");
          checkboxDiv.className = "checkbox-item";
          checkboxDiv.innerHTML = `
          <input type="checkbox" id="cat-${category.id}" value="${category.id}">
          <label for="cat-${category.id}">${category.name}</label>
        `;
          container.appendChild(checkboxDiv);
        });
      }

      // Category Management
      document.getElementById("add-category-btn").onclick = () => {
        console.log("‚ûï Adding new category");
        editingCategoryId = null; // Reset editing state
        document.getElementById("category-modal-title").textContent =
          "Add New Category";
        document.getElementById("category-form").reset();
        document.getElementById("category-id").disabled = false; // Enable ID field for new categories
        document.getElementById("category-modal").style.display = "flex";
      };

      document.getElementById("cancel-category").onclick = () => {
        document.getElementById("category-modal").style.display = "none";
      };

      window.editCategory = async (id) => {
        try {
          console.log("üîß Editing category:", id);
          editingCategoryId = id;
          document.getElementById("category-modal-title").textContent =
            "Edit Category";

          const docSnap = await getDoc(doc(db, "categories", id));
          if (!docSnap.exists()) {
            alert("Category not found!");
            return;
          }

          const data = docSnap.data();
          console.log("üìã Category data:", data);

          // Fill the form
          document.getElementById("category-id").value = id;
          document.getElementById("category-id").disabled = true; // Disable ID field when editing
          document.getElementById("category-name").value = data.name || "";
          document.getElementById("category-description").value =
            data.description || "";

          // Show modal
          document.getElementById("category-modal").style.display = "flex";
        } catch (error) {
          console.error("‚ùå Error loading category for edit:", error);
          alert("Error loading category: " + error.message);
        }
      };

      window.deleteCategory = async (id) => {
        if (
          !confirm(
            `Delete category "${id}"? This will not affect existing menu items.`
          )
        )
          return;

        try {
          await deleteDoc(doc(db, "categories", id));
          alert("Category deleted successfully");
          loadCategories();
        } catch (error) {
          alert("Error deleting category: " + error.message);
        }
      };

      document.getElementById("category-form").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("category-id").value;
        const name = document.getElementById("category-name").value;
        const description = document.getElementById(
          "category-description"
        ).value;

        const saveBtn = document.getElementById("save-category");
        saveBtn.textContent = "Saving...";
        saveBtn.disabled = true;

        try {
          const categoryData = {
            name: name,
            description: description,
            updatedAt: new Date().toISOString(),
          };

          if (editingCategoryId) {
            // Editing existing category
            await updateDoc(
              doc(db, "categories", editingCategoryId),
              categoryData
            );
            alert("Category updated successfully");
            console.log("‚úÖ Category updated:", editingCategoryId);
          } else {
            // Creating new category
            categoryData.createdAt = new Date().toISOString();
            await setDoc(doc(db, "categories", id), categoryData);
            alert("Category added successfully");
            console.log("‚úÖ Category added:", id);
          }

          document.getElementById("category-modal").style.display = "none";
          document.getElementById("category-id").disabled = false;
          await loadCategories(); // Wait for categories to reload
        } catch (error) {
          console.error("‚ùå Error saving category:", error);
          alert("Error saving category: " + error.message);
        } finally {
          saveBtn.textContent = "Save Category";
          saveBtn.disabled = false;
        }
      };

      // Item Management
      document.getElementById("add-item-btn").onclick = () => {
        editingItemId = null;
        document.getElementById("item-modal-title").textContent =
          "Add New Item";
        document.getElementById("item-form").reset();
        document.getElementById("item-available").checked = true;

        // Clear category checkboxes
        document
          .querySelectorAll('#category-checkboxes input[type="checkbox"]')
          .forEach((cb) => {
            cb.checked = false;
          });

        document.getElementById("item-modal").style.display = "flex";
      };

      document.getElementById("cancel-item").onclick = () => {
        document.getElementById("item-modal").style.display = "none";
      };

      window.editItem = async (id) => {
        editingItemId = id;
        document.getElementById("item-modal-title").textContent = "Edit Item";

        try {
          const docSnap = await getDoc(doc(db, "menuItems", id));
          const data = docSnap.data();

          document.getElementById("item-name").value = data.name;
          document.getElementById("item-price").value = data.price;
          document.getElementById("item-image").value = data.image;
          document.getElementById("item-description").value = data.description;
          document.getElementById("item-available").checked =
            data.isAvailable !== false;

          // Set category checkboxes
          document
            .querySelectorAll('#category-checkboxes input[type="checkbox"]')
            .forEach((cb) => {
              cb.checked = false;
            });

          if (data.categories && Array.isArray(data.categories)) {
            data.categories.forEach((catId) => {
              const checkbox = document.getElementById(`cat-${catId}`);
              if (checkbox) checkbox.checked = true;
            });
          } else if (data.categoryId) {
            const checkbox = document.getElementById(`cat-${data.categoryId}`);
            if (checkbox) checkbox.checked = true;
          }

          document.getElementById("item-modal").style.display = "flex";
        } catch (error) {
          alert("Error loading item: " + error.message);
        }
      };

      window.deleteItem = async (id) => {
        if (!confirm(`Delete item "${id}"?`)) return;

        try {
          await deleteDoc(doc(db, "menuItems", id));
          alert("Item deleted successfully");
          loadMenuItems();
        } catch (error) {
          alert("Error deleting item: " + error.message);
        }
      };

      document.getElementById("item-form").onsubmit = async (e) => {
        e.preventDefault();

        // Get selected categories
        const selectedCategories = [];
        document
          .querySelectorAll(
            '#category-checkboxes input[type="checkbox"]:checked'
          )
          .forEach((cb) => {
            selectedCategories.push(cb.value);
          });

        if (selectedCategories.length === 0) {
          alert("Please select at least one category");
          return;
        }

        const saveBtn = document.getElementById("save-item");
        saveBtn.textContent = "Saving...";
        saveBtn.disabled = true;

        try {
          const itemData = {
            name: document.getElementById("item-name").value,
            price: Number(document.getElementById("item-price").value),
            categories: selectedCategories,
            image: document.getElementById("item-image").value,
            description: document.getElementById("item-description").value,
            isAvailable: document.getElementById("item-available").checked,
            updatedAt: new Date().toISOString(),
          };

          if (!editingItemId) {
            itemData.createdAt = new Date().toISOString();
          }

          const itemId =
            editingItemId || itemData.name.toLowerCase().replace(/\s+/g, "-");

          if (editingItemId) {
            await updateDoc(doc(db, "menuItems", itemId), itemData);
            alert("Item updated successfully");
          } else {
            await setDoc(doc(db, "menuItems", itemId), itemData);
            alert("Item added successfully");
          }

          document.getElementById("item-modal").style.display = "none";
          loadMenuItems();
        } catch (error) {
          alert("Error saving item: " + error.message);
        } finally {
          saveBtn.textContent = "Save Item";
          saveBtn.disabled = false;
        }
      };

      // Close modals when clicking outside
      document.getElementById("category-modal").onclick = (e) => {
        if (e.target === document.getElementById("category-modal")) {
          document.getElementById("category-modal").style.display = "none";
        }
      };

      document.getElementById("item-modal").onclick = (e) => {
        if (e.target === document.getElementById("item-modal")) {
          document.getElementById("item-modal").style.display = "none";
        }
      };

      document.getElementById("logout-btn").onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
      };
    </script>
  </body>
</html>
